<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>scraper-webUI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<main class="container">
    <h1>scraper-webUI</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flash-list">
        {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <form method="post" action="/" id="scrape-form">
        <div class="grid">
            <label>
                <span>Target URL</span>
                <textarea class="no-resize" name="target_url" rows="2" placeholder="https://example.com" required></textarea>
            </label>
            <label>
                <span>Selector Type</span>
                <select name="selector_type">
                    <option value="css" selected>CSS</option>
                </select>
            </label>
        </div>

        <div class="grid">
            <label>
                <span>CSS Selector</span>
                <textarea class="no-resize" name="selector" rows="2" placeholder="a.article-link" required></textarea>
            </label>
            <label>
                <span>Attribute (Optional)</span>
                <input type="text" name="attribute" placeholder="src or data-id">
            </label>
        </div>

        <div class="grid">
            <label>
                <span>User-Agent (Optional)</span>
                <input type="text" name="user_agent" placeholder="Custom UA">
            </label>
            <label>
                <span>Max items (Optional)</span>
                <input type="number" name="max_items" min="0" placeholder="100">
            </label>
        </div>



        <details class="drawer">
            <summary>Pagination (Optional)</summary>
            <div class="grid">
                <label>
                    <span>Next page CSS selector</span>
                    <textarea name="next_selector" rows="2" placeholder="a.next"></textarea>
                </label>
                <label>
                    <span>Max pages</span>
                    <input type="number" name="max_pages" min="1" placeholder="5">
                </label>
            </div>
        </details>

        <details class="drawer">
            <summary>Detail page extraction (Optional)</summary>
            <div class="grid">
                <label>
                    <span>Detail URL selector (inside result element)</span>
                    <textarea name="detail_url_selector" rows="2" placeholder="a"></textarea>
                </label>
                <label>
                    <span>Detail URL attribute</span>
                    <input type="text" name="detail_url_attribute" placeholder="href">
                </label>
            </div>
            <div class="grid">
                <label>
                    <span>Detail image selector</span>
                    <textarea name="detail_image_selector" rows="2" placeholder="#image, article img.main"></textarea>
                </label>
                <label>
                    <span>Detail image attribute</span>
                    <input type="text" name="detail_image_attribute" placeholder="src">
                </label>
            </div>
            <p class="help">Use this when the listing shows thumbnails but the full image is on the detail page.</p>
        </details>

        <div class="controls-inline">
            <label class="checkbox">
                <input type="checkbox" name="respect_robots" value="1" checked>
                Respect robots.txt
            </label>
            <label class="checkbox">
                <input type="checkbox" name="fast_mode" value="1">
                Fast mode (Fewer retries, shorter backoff) [Experimental]
            </label>
            <label class="checkbox">
                <input type="checkbox" name="randomize_user_agent" value="1">
                Randomize User-Agent
            </label>
        </div>

        <div class="actions">
            <button type="submit">Scrape</button>
        </div>
    </form>

    <p class="help">Tip: Try selector <code>a</code> to list links, or <code>img</code> with attribute <code>src</code>.</p>
    <p class="help">For image previews + download buttons, use selector <code>img</code> or a selector whose attribute resolves to an image URL.</p>
    <p class="help">Please respect target site Terms of Service. Keep request volume low.</p>

    <hr>
    <h3 style="margin:8px 0">Scrape presets</h3>
    <div class="grid">
        <label>
            <span>Preset</span>
            <select id="preset">
                <option value="">-- Choose a preset --</option>
                {% for p in presets %}
                <option
                    value="{{ p.id }}"
                    data-url="{{ p.url }}"
                    data-selector="{{ p.selector }}"
                    data-attribute="{{ p.attribute }}"
                    data-user_agent="{{ p.user_agent }}"
                    data-max_items="{{ p.max_items }}"
                    data-next_selector="{{ p.next_selector }}"
                    data-max_pages="{{ p.max_pages }}"
                    data-respect_robots="{{ p.respect_robots }}"
                    data-detail_url_selector="{{ p.detail_url_selector }}"
                    data-detail_url_attribute="{{ p.detail_url_attribute }}"
                    data-detail_image_selector="{{ p.detail_image_selector }}"
                    data-detail_image_attribute="{{ p.detail_image_attribute }}"
                >{{ p.name }}</option>
                {% endfor %}
            </select>
        </label>
                <div style="display:flex; align-items:flex-end; gap:8px;">
                        <button type="button" id="btn-save-preset" class="btn">Save preset</button>
                        <button type="button" id="btn-delete-preset" class="btn btn-danger">Delete preset</button>
                </div>
    </div>

    <script>
        (function() {
            const form = document.getElementById('scrape-form');
            const preset = document.getElementById('preset');
            const set = (name, value) => { const el = form.elements[name]; if (el) el.value = value; };
            const get = (name) => { const el = form.elements[name]; return el ? el.value : ''; };
            const fetchJson = async (url, opts = {}) => {
                const res = await fetch(url, Object.assign({ headers: { 'Content-Type': 'application/json' } }, opts));
                let body = null; try { body = await res.json(); } catch (e) {}
                if (!res.ok || (body && body.ok === false)) { throw new Error((body && body.error) || res.statusText); }
                return body || { ok: true };
            };

            preset.addEventListener('change', () => {
                const opt = preset.options[preset.selectedIndex];
                if (!opt || !opt.dataset) return;
                // Reset optional fields
                set('attribute',''); set('user_agent',''); set('max_items',''); set('next_selector',''); set('max_pages','');
                set('detail_url_selector',''); set('detail_url_attribute',''); set('detail_image_selector',''); set('detail_image_attribute','');
                // Fill from dataset
                set('target_url', opt.dataset.url || '');
                set('selector', opt.dataset.selector || '');
                set('attribute', opt.dataset.attribute || '');
                set('user_agent', opt.dataset.user_agent || '');
                set('max_items', opt.dataset.max_items || '');
                set('next_selector', opt.dataset.next_selector || '');
                set('max_pages', opt.dataset.max_pages || '');
                set('detail_url_selector', opt.dataset.detail_url_selector || '');
                set('detail_url_attribute', opt.dataset.detail_url_attribute || '');
                set('detail_image_selector', opt.dataset.detail_image_selector || '');
                set('detail_image_attribute', opt.dataset.detail_image_attribute || '');
                const rr = (opt.dataset.respect_robots || '1');
                const rrBox = form.elements['respect_robots'];
                if (rrBox) rrBox.checked = (rr === '1' || rr.toLowerCase() === 'true');
            });

            const updateDropdownOption = (p) => {
                // Try find existing option by value=id
                let opt = Array.from(preset.options).find(o => o.value === p.id);
                if (!opt) {
                    opt = document.createElement('option');
                    preset.appendChild(opt);
                }
                opt.value = p.id;
                opt.textContent = p.name;
                opt.dataset.url = p.url || '';
                opt.dataset.selector = p.selector || '';
                opt.dataset.attribute = p.attribute || '';
                opt.dataset.user_agent = p.user_agent || '';
                opt.dataset.max_items = p.max_items || '';
                opt.dataset.next_selector = p.next_selector || '';
                opt.dataset.max_pages = p.max_pages || '';
                opt.dataset.respect_robots = (p.respect_robots || '1');
                opt.dataset.detail_url_selector = p.detail_url_selector || '';
                opt.dataset.detail_url_attribute = p.detail_url_attribute || '';
                opt.dataset.detail_image_selector = p.detail_image_selector || '';
                opt.dataset.detail_image_attribute = p.detail_image_attribute || '';
                preset.value = p.id;
            };

            document.getElementById('btn-save-preset').addEventListener('click', async () => {
                try {
                    const currentId = preset.value || '';
                    const defaultId = currentId || (get('selector').slice(0, 20).replace(/[^a-z0-9_-]+/gi,'_').toLowerCase() || 'my_preset');
                    const id = prompt('Preset ID (no spaces):', defaultId);
                    if (!id) return;
                    const name = prompt('Preset display name:', currentId ? preset.options[preset.selectedIndex].textContent : 'My Preset');
                    if (!name) return;
                    const payload = {
                        id: id.trim(),
                        name: name.trim(),
                        url: get('target_url'),
                        selector: get('selector'),
                        attribute: get('attribute'),
                        user_agent: get('user_agent'),
                        max_items: get('max_items'),
                        next_selector: get('next_selector'),
                        max_pages: get('max_pages'),
                        respect_robots: (form.elements['respect_robots'] && form.elements['respect_robots'].checked) ? '1' : '0',
                        detail_url_selector: get('detail_url_selector'),
                        detail_url_attribute: get('detail_url_attribute'),
                        detail_image_selector: get('detail_image_selector'),
                        detail_image_attribute: get('detail_image_attribute'),
                    };
                    const res = await fetchJson('/presets/save', { method: 'POST', body: JSON.stringify(payload) });
                    if (res && res.preset) updateDropdownOption(res.preset);
                    alert('Preset saved');
                } catch (e) {
                    alert('Failed to save preset: ' + e.message);
                }
            });

            document.getElementById('btn-delete-preset').addEventListener('click', async () => {
                const id = preset.value;
                if (!id) { alert('Choose a preset to delete.'); return; }
                if (!confirm('Delete preset "' + preset.options[preset.selectedIndex].textContent + '"?')) return;
                try {
                    const res = await fetchJson('/presets/delete', { method: 'POST', body: JSON.stringify({ id }) });
                    if (res && res.ok) {
                        // Remove option
                        const opt = Array.from(preset.options).find(o => o.value === id);
                        if (opt) opt.remove();
                        preset.value = '';
                        alert('Preset deleted');
                    }
                } catch (e) {
                    alert('Failed to delete preset: ' + e.message);
                }
            });
        })();
    </script>
</main>
<footer class="footer">
    <small>scraper-webUI by G0246</small>
</footer>
</body>
</html>
